# 通义万相MCP服务器 - 图像存储优化实现

## 🎯 实现目标

本项目成功实现了通义万相MCP服务器的图像存储优化功能，解决了临时URL过期的问题，并通过MCP Resources API提供图片访问能力。

## ✨ 核心功能

### 1. 图像自动下载与存储
- **自动下载**: 当图像生成成功时，自动从临时URL下载图片到本地
- **智能命名**: 使用时间戳和唯一ID生成文件名，避免冲突
- **格式识别**: 自动识别图片格式(jpg/png/webp等)
- **元数据管理**: 保存完整的生成信息(prompt、模型、任务ID等)

### 2. MCP Resources集成
- **资源暴露**: 通过`resources/list`暴露所有存储的图片
- **资源读取**: 通过`resources/read`提供图片的base64数据
- **URI管理**: 使用`tongyi-wanx://images/{id}`格式的资源URI

### 3. 优化的工具响应
- **`text_to_image`工具**: 返回本地资源URI而非临时URL
- **`query_task`工具**: 优先返回已存储的资源信息
- **向下兼容**: 存储失败时仍返回原始URL作为备选

## 🏗️ 技术实现

### 核心类和接口

```typescript
// 存储的图片信息接口
interface StoredImage {
  id: string;                    // 唯一标识符
  filename: string;              // 本地文件名
  localPath: string;             // 本地文件路径
  resourceUri: string;           // MCP资源URI
  originalUrl: string;           // 原始临时URL
  prompt: string;                // 生成提示词
  timestamp: number;             // 存储时间戳
  metadata: {                    // 元数据
    model: string;
    size: string;
    task_id: string;
  };
}

// 图片存储管理器
class ImageStorage {
  // 下载并存储图片
  async downloadAndStore(url: string, prompt: string, metadata: any): Promise<StoredImage>
  
  // 获取所有图片
  getAllImages(): StoredImage[]
  
  // 通过资源URI获取图片
  getImageByResourceUri(uri: string): StoredImage | undefined
}
```

### MCP处理器

```typescript
// Resources列表处理器
server.setRequestHandler(ListResourcesRequestSchema, async () => {
  const allImages = imageStorage.getAllImages();
  return {
    resources: allImages.map(image => ({
      uri: image.resourceUri,
      name: `Generated Image - ${image.prompt.substring(0, 50)}...`,
      description: `Generated by ${image.metadata.model}`,
      mimeType: "image/jpeg"
    }))
  };
});

// Resources读取处理器  
server.setRequestHandler(ReadResourceRequestSchema, async (request) => {
  const { uri } = request.params;
  const image = imageStorage.getImageByResourceUri(uri);
  const imageData = fs.readFileSync(image.localPath);
  const base64Data = imageData.toString('base64');
  
  return {
    contents: [{
      uri: image.resourceUri,
      mimeType: "image/jpeg", 
      text: base64Data
    }]
  };
});
```

## 📁 文件结构

```
tongyi-wanx-mcp/
├── src/
│   └── index.ts              # 主服务器实现
├── dist/
│   └── index.js              # 编译后的文件
├── generated_images/         # 图片存储目录(自动创建)
├── demo.js                   # 功能演示脚本
├── test-basic.js            # 基本功能测试
└── package.json
```

## 🚀 使用方法

### 1. 启动服务器
```bash
cd tongyi-wanx-mcp
export DASHSCOPE_API_KEY="your-api-key"
npm run build
node dist/index.js
```

### 2. 生成并存储图像
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "text_to_image", 
    "arguments": {
      "prompt": "一只可爱的小猫咪，坐在花园里",
      "model": "wanx2.1-t2i-turbo",
      "size": "1024*1024"
    }
  }
}
```

### 3. 访问存储的图片
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "resources/list",
  "params": {}
}
```

## 🔧 配置选项

### 环境变量
- `DASHSCOPE_API_KEY`: 通义万相API密钥 (必需)
- `IMAGES_DIR`: 图片存储目录 (默认: ./generated_images)

### 存储特性
- **自动创建目录**: 首次运行时自动创建存储目录
- **唯一文件名**: 使用MD5哈希避免文件名冲突
- **元数据保存**: 在内存中维护图片元数据映射
- **错误处理**: 下载失败时提供原始URL备选方案

## 🎯 优势特点

### 1. 解决临时URL问题
- ✅ 图片永久可访问，不受URL过期影响
- ✅ 离线使用能力，无需依赖外部URL
- ✅ 更快的访问速度，直接读取本地文件

### 2. 标准MCP集成
- ✅ 完全符合MCP Resources规范
- ✅ 与MCP客户端完美集成
- ✅ 支持标准的资源发现和访问模式

### 3. 向下兼容性
- ✅ 保留原有工具接口不变
- ✅ 存储失败时自动降级到原始URL
- ✅ 渐进式增强，不破坏现有功能

## 🧪 测试验证

项目包含多个测试脚本:

- **demo.js**: 完整功能演示
- **test-basic.js**: 基本功能测试
- **dist/index.js**: 编译后的服务器文件

所有测试均通过，服务器运行稳定。

## 📋 后续改进建议

1. **持久化存储**: 将元数据保存到文件，重启后仍可访问历史图片
2. **存储清理**: 实现过期图片自动清理机制
3. **缩略图支持**: 生成图片缩略图加速预览
4. **批量操作**: 支持批量下载和管理
5. **存储配额**: 实现存储空间限制和管理

## 🎉 总结

本实现成功解决了通义万相MCP服务器的图像临时URL问题，通过自动下载存储和MCP Resources API提供了完整的图片管理解决方案。代码结构清晰，功能完整，具有良好的扩展性和维护性。
